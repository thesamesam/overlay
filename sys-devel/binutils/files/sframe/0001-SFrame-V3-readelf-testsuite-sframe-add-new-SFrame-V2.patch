From 3e8f6fd615a161679f767a724e0eaae4854b8f86 Mon Sep 17 00:00:00 2001
Message-ID: <3e8f6fd615a161679f767a724e0eaae4854b8f86.1768401239.git.sam@gentoo.org>
From: Indu Bhagat <indu.bhagat@oracle.com>
Date: Fri, 5 Dec 2025 12:24:30 -0800
Subject: [PATCH 01/40] [SFrame-V3] readelf: testsuite: sframe: add new SFrame
 V2 test

In subsequent commits, we will add support for SFrame V3.  In the next
GNU Binutils release, GNU as and ld will only generate SFrame V3; SFrame
V2 will not be supported for generation nor linking.

For readelf/objdump, however, continue to support textual dump of SFrame
V2 sections.  Add a binary file (with no debug data) with SFrame V2
section to keep the dumping tested.

Add ET_REL And ET_EXEC binary file based tests for x86_64 and s390x.
Check that both readelf and objdump works on the SFrame V2 sections.

binutils/testsuite/
	* binutils-all/s390/README-sframe-tests: New test.
	* binutils-all/s390/sframe.exp: New test.
	* binutils-all/s390/test-v2-ET_EXEC.sframe.bz2: New test.
	* binutils-all/s390/test-v2-ET_EXEC.sframe.dump: New test.
	* binutils-all/s390/test-v2-ET_REL.sframe.bz2: New test.
	* binutils-all/s390/test-v2-ET_REL.sframe.dump: New test.
	* binutils-all/x86-64/README-sframe-tests: New test.
	* binutils-all/x86-64/sframe.exp: New test.
	* binutils-all/x86-64/test-v2-ET_EXEC.sframe.bz2: New test.
	* binutils-all/x86-64/test-v2-ET_EXEC.sframe.dump: New test.
	* binutils-all/x86-64/test-v2-ET_REL.sframe.bz2: New test.
	* binutils-all/x86-64/test-v2-ET_REL.sframe.dump: New test.

---
[Changes in V1]
  - Use regexp_diff for the testcases [Indu].
  - Add binary data based (ET_REL and ET_EXEC) tests for s390x [Jan,
    Jens].
  - Add objdump to the testcase as well [Jan].
  - Add a README-sframe-tests file containing the instructions to
    recreate the binary data files [Jan].
[End of changes in V1]

[No Changes in V2]

[Changes in V3]
  - Update Copyright yr 2026 in new files.
  - Use assembler input for x86_64 tests [Jan].
  - Use assembler input for s390x tests [Jan].
  - Update READMEs accordingly.
[End of changes in V3]
---
 .../binutils-all/s390/README-sframe-tests     | 175 ++++++++++++++++++
 .../testsuite/binutils-all/s390/sframe.exp    |  63 +++++++
 .../s390/test-v2-ET_EXEC.sframe.bz2           | Bin 0 -> 1498 bytes
 .../s390/test-v2-ET_EXEC.sframe.dump          |  51 +++++
 .../s390/test-v2-ET_REL.sframe.bz2            | Bin 0 -> 851 bytes
 .../s390/test-v2-ET_REL.sframe.dump           |  42 +++++
 .../binutils-all/x86-64/README-sframe-tests   |  96 ++++++++++
 .../testsuite/binutils-all/x86-64/sframe.exp  |  63 +++++++
 .../x86-64/test-v2-ET_EXEC.sframe.bz2         | Bin 0 -> 1424 bytes
 .../x86-64/test-v2-ET_EXEC.sframe.dump        |  45 +++++
 .../x86-64/test-v2-ET_REL.sframe.bz2          | Bin 0 -> 777 bytes
 .../x86-64/test-v2-ET_REL.sframe.dump         |  33 ++++
 12 files changed, 568 insertions(+)
 create mode 100644 binutils/testsuite/binutils-all/s390/README-sframe-tests
 create mode 100644 binutils/testsuite/binutils-all/s390/sframe.exp
 create mode 100644 binutils/testsuite/binutils-all/s390/test-v2-ET_EXEC.sframe.bz2
 create mode 100644 binutils/testsuite/binutils-all/s390/test-v2-ET_EXEC.sframe.dump
 create mode 100644 binutils/testsuite/binutils-all/s390/test-v2-ET_REL.sframe.bz2
 create mode 100644 binutils/testsuite/binutils-all/s390/test-v2-ET_REL.sframe.dump
 create mode 100644 binutils/testsuite/binutils-all/x86-64/README-sframe-tests
 create mode 100644 binutils/testsuite/binutils-all/x86-64/sframe.exp
 create mode 100644 binutils/testsuite/binutils-all/x86-64/test-v2-ET_EXEC.sframe.bz2
 create mode 100644 binutils/testsuite/binutils-all/x86-64/test-v2-ET_EXEC.sframe.dump
 create mode 100644 binutils/testsuite/binutils-all/x86-64/test-v2-ET_REL.sframe.bz2
 create mode 100644 binutils/testsuite/binutils-all/x86-64/test-v2-ET_REL.sframe.dump

diff --git a/binutils/testsuite/binutils-all/s390/README-sframe-tests b/binutils/testsuite/binutils-all/s390/README-sframe-tests
new file mode 100644
index 00000000000..f6d977662e3
--- /dev/null
+++ b/binutils/testsuite/binutils-all/s390/README-sframe-tests
@@ -0,0 +1,175 @@
+The tests in sframe.exp use binary data files:
+  - test-v2-ET_EXEC.sframe.bz2
+  - test-v2-ET_REL.sframe.bz2
+These files are generated using a as/ld supporting SFrame V2 sections (Binutils
+<= 2.45).  The purpose of those tests is to make sure readelf/objdump support
+works for SFrame V2.
+
+The binary files are generated using the following steps.
+
+$ cat sort.s
+	.machinemode zarch
+	.machine "z900"
+.text
+	.align	8
+	.globl swapit
+	.type	swapit, @function
+swapit:
+	.cfi_startproc
+	stmg	%r11,%r15,88(%r15)
+	.cfi_offset 11, -72
+	.cfi_offset 12, -64
+	.cfi_offset 13, -56
+	.cfi_offset 14, -48
+	.cfi_offset 15, -40
+	aghi	%r15,-176
+	.cfi_def_cfa_offset 336
+	lgr	%r11,%r15
+	.cfi_def_cfa_register 11
+	stg	%r2,168(%r11)
+	stg	%r3,160(%r11)
+	lg	%r1,160(%r11)
+	l	%r2,0(%r1)
+	lg	%r1,168(%r11)
+	st	%r2,0(%r1)
+	nopr	%r0
+	lmg	%r11,%r15,264(%r11)
+	.cfi_restore 15
+	.cfi_restore 14
+	.cfi_restore 13
+	.cfi_restore 12
+	.cfi_restore 11
+	.cfi_def_cfa 15, 160
+	br	%r14
+	.cfi_endproc
+	.size	swapit, .-swapit
+
+	.align	8
+	.globl fake_sort
+	.type	fake_sort, @function
+fake_sort:
+	.cfi_startproc
+	stmg	%r11,%r15,88(%r15)
+	.cfi_offset 11, -72
+	.cfi_offset 12, -64
+	.cfi_offset 13, -56
+	.cfi_offset 14, -48
+	.cfi_offset 15, -40
+	aghi	%r15,-176
+	.cfi_def_cfa_offset 336
+	lgr	%r11,%r15
+	.cfi_def_cfa_register 11
+	stg	%r2,168(%r11)
+	lgr	%r1,%r3
+	st	%r1,164(%r11)
+	l	%r1,164(%r11)
+	ltr	%r1,%r1
+	jle	.L5
+	lgf	%r1,164(%r11)
+	sllg	%r1,%r1,2
+	aghi	%r1,-4
+	ag	%r1,168(%r11)
+	lgr	%r3,%r1
+	lg	%r2,168(%r11)
+	brasl	%r14,swapit@PLT
+.L5:
+	nopr	%r0
+	lg	%r4,288(%r11)
+	lmg	%r11,%r15,264(%r11)
+	.cfi_restore 15
+	.cfi_restore 14
+	.cfi_restore 13
+	.cfi_restore 12
+	.cfi_restore 11
+	.cfi_def_cfa 15, 160
+	br	%r4
+	.cfi_endproc
+	.size	fake_sort, .-fake_sort
+
+	.align	8
+	.globl sort_array
+	.type	sort_array, @function
+sort_array:
+	.cfi_startproc
+	stmg	%r11,%r15,88(%r15)
+	.cfi_offset 11, -72
+	.cfi_offset 12, -64
+	.cfi_offset 13, -56
+	.cfi_offset 14, -48
+	.cfi_offset 15, -40
+	aghi	%r15,-672
+	.cfi_def_cfa_offset 832
+	lgr	%r11,%r15
+	.cfi_def_cfa_register 11
+	lgr	%r1,%r11
+	aghi	%r1,160
+	lghi	%r3,128
+	lgr	%r2,%r1
+	brasl	%r14,fake_sort@PLT
+	nopr	%r0
+	lg	%r4,784(%r11)
+	lmg	%r11,%r15,760(%r11)
+	.cfi_restore 15
+	.cfi_restore 14
+	.cfi_restore 13
+	.cfi_restore 12
+	.cfi_restore 11
+	.cfi_def_cfa 15, 160
+	br	%r4
+	.cfi_endproc
+	.size	sort_array, .-sort_array
+
+	.section	.rodata
+	.align	2
+.LC0:
+	.string	"done"
+
+	.text
+	.align	8
+	.globl main
+	.type	main, @function
+main:
+	.cfi_startproc
+	stmg	%r11,%r15,88(%r15)
+	.cfi_offset 11, -72
+	.cfi_offset 12, -64
+	.cfi_offset 13, -56
+	.cfi_offset 14, -48
+	.cfi_offset 15, -40
+	aghi	%r15,-160
+	.cfi_def_cfa_offset 320
+	lgr	%r11,%r15
+	.cfi_def_cfa_register 11
+	brasl	%r14,sort_array@PLT
+	larl	%r2,.LC0
+	brasl	%r14,printf@PLT
+	lhi	%r1,0
+	lgfr	%r1,%r1
+	lgr	%r2,%r1
+	lg	%r4,272(%r11)
+	lmg	%r11,%r15,248(%r11)
+	.cfi_restore 15
+	.cfi_restore 14
+	.cfi_restore 13
+	.cfi_restore 12
+	.cfi_restore 11
+	.cfi_def_cfa 15, 160
+	br	%r4
+	.cfi_endproc
+	.size	main, .-main
+
+	.globl	_start
+	.type	_start, @function
+_start:
+	brasl %r14,_start
+	.size _start, .-_start
+
+$ as --gsframe -o sort.o sort.s
+$ ld -lc sort.o -o sort
+
+$ cp sort test-v2-ET_EXEC.sframe
+$ chmod -x test-v2-ET_EXEC.sframe
+$ bzip2 test-v2-ET_EXEC.sframe
+
+$ cp sort.o test-v2-ET_REL.sframe
+$ bzip2 test-v2-ET_REL.sframe
diff --git a/binutils/testsuite/binutils-all/s390/sframe.exp b/binutils/testsuite/binutils-all/s390/sframe.exp
new file mode 100644
index 00000000000..0522d683b1f
--- /dev/null
+++ b/binutils/testsuite/binutils-all/s390/sframe.exp
@@ -0,0 +1,63 @@
+# Expect script for s390 object tests for SFrame.
+#   Copyright (C) 2026 Free Software Foundation, Inc.
+#
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 3 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston,
+# MA 02110-1301, USA.
+
+if {![istarget "s390x-*-linux*"] || [is_remote host]} {
+    return
+}
+
+set tempfile tmpdir/sframe-testbin
+
+set test_list [lsort [glob -nocomplain $srcdir/$subdir/*.sframe.bz2]]
+foreach t $test_list {
+    # We need to strip the ".bz2", but can leave the dirname.
+    set test $subdir/[file tail $t]
+    set testname [file rootname $test]
+    verbose $testname
+
+    # We will check against the expected output in file named ${dumpfile}.dump
+    set dumpfile [file rootname $t]
+
+    if {[catch "system \"bzip2 -dc $t > $tempfile\""] != 0} {
+	untested "bzip2 -dc ($tempfile)"
+	continue
+    }
+
+    # Check readelf output of SFrame V2 sections.
+    set got [remote_exec host "$READELF --sframe $tempfile" "" "/dev/null" "${tempfile}.out"]
+    if { [lindex $got 0] != 0 || ![string match "" [lindex $got 1]] } then {
+	fail "readelf SFrame V2 ($testname)"
+	continue
+    }
+
+    if { [regexp_diff "${tempfile}.out" "${dumpfile}.dump"] } then {
+	fail "readelf SFrame V2 ($testname)"
+    }
+    pass "readelf SFrame V2 ($testname)"
+
+    # Check objdump output of SFrame V2 sections as well.
+    set got [remote_exec host "$OBJDUMP --sframe $tempfile" "" "/dev/null" "${tempfile}.out"]
+    if { [lindex $got 0] != 0 || ![string match "" [lindex $got 1]] } then {
+	fail "objdump SFrame V2 ($testname)"
+	continue
+    }
+
+    if { [regexp_diff "${tempfile}.out" "${dumpfile}.dump"] } then {
+	fail "objdump SFrame V2 ($testname)"
+    }
+    pass "objdump SFrame V2 ($testname)"
+}
diff --git a/binutils/testsuite/binutils-all/s390/test-v2-ET_EXEC.sframe.bz2 b/binutils/testsuite/binutils-all/s390/test-v2-ET_EXEC.sframe.bz2
new file mode 100644
index 0000000000000000000000000000000000000000..1f66b015e736f3cf2f4d168d4dd8d985e56ff0e8
GIT binary patch
literal 1498
zcmV<01tt1IT4*^jL0KkKS<FO1PyhwO|NsC0|IO^*_j3RD-2MOm|M<vHq;y2Ud|~8I
z&_fzYXJ60-6;<iOYy)l8q0ECqNvYx!(3qZrCVE8jO%0%G4@hZ{1JpDFMvVrHjUG_Y
z21bFP8U~FS0h%Dx$eL&-jHUrkDf&}D#AqI&ri}nJXc`&-00w{n00HV~1Jn%C27n~g
ziX+qoJxx7NQ`0EO+JFE6GynrY00*dO0000zKmZ<~14BR{Xk^n(F){|485$Wh(9mgw
z$YL1*f-xC113`i@7$%x91TX?JX_H0?6sDO|^i53+gAi$<>H(l>rh`U<Mw$Qzs5BY?
zGH3t*0001F0i>#Rh7!qaN<Quz$~S>07y6hf-NM{OXb}S?l+VyP-LQzL0ujN+0<`W8
z_I_$JNo7VYK>z?W^eCV+A({p`$J2MaUn&j17o9EIu}L>!BaF#-s+B5YKgExya3-pb
zHLPx1EMpXx#3>S@ovNVlXxJpvbnDs*cDm*~p*Euq<XXg$R_#G+VoQxO3^{*Ck?fIw
zZ#HF{cIlSNXHsqH*(Vzp1wB*=^|nbM9U#heC)!cTQi63Crm7esuSwZcC%It$OL`X4
zAi%T>e={5kAxzAP;sJNjyvFb4dnn^f5FtJ@KnE$PJ0=1tYHjNx07XU<lUsF1EwZkZ
z41UvnwX~_-XILi|%DqK_5Hlht#xK->iYydkEemDXNUzXVW$j+@T-V@2%(}&$g}Z6G
z5o)T1z3<hw9<GoK3#e*Q$wCFHFbEJcA_NVJf&m4D#Dy{nMT8UqW~Cs}A~&m*R&6LD
z%rGt>Or{eCK(jO00C7#ESce$G1w=v&gartyA`1nEOPSD(%No0Sryf&?Eg)uty5HPW
z1cF8hP-0cAPP<7<*);k|0FBT<F{lu>2A{x1ud;al3;#ElX<Lx8GN96%LJ<rU6L7<_
z=EKE!Kq{Asch4cA?b^ZZX#9R{=IJ(pp-4N53Rxw!tAY+1r%s3Boz^{Slv@TFJ6(Gc
zOh#oun+RsG<#VetIsP4B-b7;-Eeiq7s&lCA(#eK8l6s7W^@OuE&E6I+iVGD~6f#RS
z4qG^_$D^&g>@mopkAP%^FlM4<rI23c10kBoEL|q-3p*g$MqRzAnHJKT4#;B1{#4Qr
z)UBw9c*R3)5EP$qZ*$3R4zM!t+BGk0bEVr$mdH=csU;fWSRwcVOX1T6izM^e7~|e>
z?6$yY&|S(EVKABuoSmv7APwUiiMjZa^TFhbruPs|*W5?^W*?Z|V4!g0Q)Q+e;HX|}
zt+MeRUl?e?oOt4jTC5;UMa&Y576W;Gy;l0w${;&xD^FI_PivQ_FF21@fWG-Ml|J<<
z0y`IAmViD*d#f-nwuXj<`_ect*MXNh@T9g!s4#78t%<?DPOY&vX%t+(vodRJeVH7O
z)O`+CGgF05kT0Y9eY+#q>p<N%kyx<Mk?^pHWS3=Zc6u(Y>x?WooJ~h0oc5%FR1Ev;
zxL#6_R-0483aa$hHiHWXpPI1Kae?<T#IwT<XFpy2pk8rZh2T2Q$hwJp(Va#DTZm|%
zTn7#yBr<ZAfou~YCjCgE5MN7Vkl?|M?*no^q87#pw1b~0jk7S6Vj=M%B9cObg3cM>
z6`A4KC5;;BQl)Ab+`v;EAu!2;CX`Kr4n0)k$TZSVFo?;I?o~xfC&3D^I_U#NAZSQS
zz)gxbS`0%|a(6K$L7E!CHOCB?NEQJR!(TOnaAX^8kSABg*e;PI7Ds<ychc>JDfk3h
zQ!Fmudcxte@~y_@j_?)j2=A%uI0o>;mmtA{Jb<ROsN~rG+sK$O8nOkT28a~E(gK9}
zx%L7edId}&zXpd*upNZUAB^dB(r7QIC$l6kSh%B8xd;U@IL5B6@L<hGELnySi$76L
z5F=`uY{^A`oRppg5RUnRoWco#WYDczO<PEyGx5u#f98z24A1;s$rRy2LopErKq0uB
AX#fBK

literal 0
HcmV?d00001

diff --git a/binutils/testsuite/binutils-all/s390/test-v2-ET_EXEC.sframe.dump b/binutils/testsuite/binutils-all/s390/test-v2-ET_EXEC.sframe.dump
new file mode 100644
index 00000000000..cd3a652b40e
--- /dev/null
+++ b/binutils/testsuite/binutils-all/s390/test-v2-ET_EXEC.sframe.dump
@@ -0,0 +1,51 @@
+#...
+Contents of the SFrame section .sframe:
+  Header :
+
+    Version: SFRAME_VERSION_2
+    Flags: SFRAME_F_FDE_SORTED,
+           SFRAME_F_FDE_FUNC_START_PCREL
+    Num FDEs: 6
+    Num FREs: 22
+
+  Function Index :
+
+    func idx \[0\]: pc = 0x10002b0, size = 32 bytes
+    STARTPC +CFA +FP +RA +
+    00000000010002b0 +sp\+160 +u +u +
+
+    func idx \[1\]: pc = 0x10002d0, size = 32 bytes
+    STARTPC\[m\] +CFA +FP +RA +
+    0000000000000000 +sp\+160 +u +u +
+
+    func idx \[2\]: pc = 0x10002f0, size = 56 bytes
+    STARTPC +CFA +FP +RA +
+    00000000010002f0 +sp\+160 +u +u +
+    00000000010002f6 +sp\+160 +c-72 +c-48 +
+    00000000010002fa +sp\+336 +c-72 +c-48 +
+    00000000010002fe +fp\+336 +c-72 +c-48 +
+    0000000001000326 +sp\+160 +u +u +
+
+    func idx \[3\]: pc = 0x1000328, size = 92 bytes
+    STARTPC +CFA +FP +RA +
+    0000000001000328 +sp\+160 +u +u +
+    000000000100032e +sp\+160 +c-72 +c-48 +
+    0000000001000332 +sp\+336 +c-72 +c-48 +
+    0000000001000336 +fp\+336 +c-72 +c-48 +
+    0000000001000382 +sp\+160 +u +u +
+
+    func idx \[4\]: pc = 0x1000388, size = 52 bytes
+    STARTPC +CFA +FP +RA +
+    0000000001000388 +sp\+160 +u +u +
+    000000000100038e +sp\+160 +c-72 +c-48 +
+    0000000001000392 +sp\+832 +c-72 +c-48 +
+    0000000001000396 +fp\+832 +c-72 +c-48 +
+    00000000010003ba +sp\+160 +u +u +
+
+    func idx \[5\]: pc = 0x10003c0, size = 58 bytes
+    STARTPC +CFA +FP +RA +
+    00000000010003c0 +sp\+160 +u +u +
+    00000000010003c6 +sp\+160 +c-72 +c-48 +
+    00000000010003ca +sp\+320 +c-72 +c-48 +
+    00000000010003ce +fp\+320 +c-72 +c-48 +
+    00000000010003f8 +sp\+160 +u +u +
diff --git a/binutils/testsuite/binutils-all/s390/test-v2-ET_REL.sframe.bz2 b/binutils/testsuite/binutils-all/s390/test-v2-ET_REL.sframe.bz2
new file mode 100644
index 0000000000000000000000000000000000000000..0adf558bdffbbb6d0992f7557c9e70c53c21320f
GIT binary patch
literal 851
zcmV-Z1FZZ)T4*^jL0KkKSwQn&KmY>ifB*mg|88}4b#c!|R#f+Y-1NW?z(7RAcwod2
zz(HF~L{Gp1((N=DCJjv{R6J^%QKo^TAQ=GAWDGz620+tI05miKpa2Fzph7f;LrM=*
zOw<9UfB~Ql2dDr5XaF(*(X}4bfC3Dd0Wbg)00000m?i)w005Yn005YnfJmYyg*`PM
ziRx`l14fzvGy~MoY@<L1k4VrDPyjRsq-bfGKvRT<o=0t-kYBu5rjC%v)P4?qru}WT
zrIz~vf_#4_T-3z%vSwQ<GP5RLFWV`3HS363-YXlJm$-PK?oJ?v^hDGH7{z{TwqA1A
zQclXusR>d7S8^6~&=9e2-q&4SxMw4SqN2fuz&9fSZvFyESINZDkmpYpJ(v|`;naXG
zRG%%yZ4BJ9coN-!jzb7_O)=0|$;i6sK8|lbghpoJDw&wM$3g}MLI4QN88iSkB->~P
z&;dE5D@?;;1XH{`e}sfFv0PGAL4+DgMj>-6@FFUVMOKfC&%lI?5Gzm^Y)c66iuY%b
zhC36YrPI3f8*G)$B={(Q0On8x9)R`GMOd`J+iP3_Mua3;Sy7AM12#gQ)Cm}Oo|99Z
zV<vv;fhxhZQ@P!@5S@y^160;n%lz~X0etE(Y!x=H1Y{#1+eKA=?gUD}))2D@P)r8y
z2Am*K3>5?DJm70MH84oB4ICDeQHS3Vs2w18CJ2OVB5xfpw-}s@rGB&u*R}J#79-}T
zC}cFQnGIxbC<qWR7+I1EhR3VTT5Q_1P$CzoO4{LE)NsrLGBlf0EFXyFG%y_^D^RFr
z`5?s!3CimxGQh*)cncKuJtHZJwpM?_s7A!El`}xoHMW89ei!Cp{jl+XjJ|w|hK75v
z2F5J$Rg1jJ!l%el5b4&ok*y5{R}>I*DxBn^BB)7hK60*Z5fh16PcK<Ctj8Vn=q3g!
zi|!#_rV6pe#5i?A*l>dkHeoP(4!S47I~Hws{{f9MCZW{LVP&&LTN{@!6&XD=usr5L
zea!|8DB2^1p=va&=>^cdAD}U<pnbGvf`H@i9^j5iL4LWGiJq<kX%aNd7p74J5lxPC
d=r9IT<4m)50w$!4ci5le?ntK!5(pk^=m0!SYfJzD

literal 0
HcmV?d00001

diff --git a/binutils/testsuite/binutils-all/s390/test-v2-ET_REL.sframe.dump b/binutils/testsuite/binutils-all/s390/test-v2-ET_REL.sframe.dump
new file mode 100644
index 00000000000..2cc17963385
--- /dev/null
+++ b/binutils/testsuite/binutils-all/s390/test-v2-ET_REL.sframe.dump
@@ -0,0 +1,42 @@
+#...
+Contents of the SFrame section .sframe:
+  Header :
+
+    Version: SFRAME_VERSION_2
+    Flags: SFRAME_F_FDE_FUNC_START_PCREL
+    Num FDEs: 4
+    Num FREs: 20
+
+  Function Index :
+
+    func idx \[0\]: pc = 0x0, size = 56 bytes
+    STARTPC +CFA +FP +RA +
+    0000000000000000 +sp\+160 +u +u +
+    0000000000000006 +sp\+160 +c-72 +c-48 +
+    000000000000000a +sp\+336 +c-72 +c-48 +
+    000000000000000e +fp\+336 +c-72 +c-48 +
+    0000000000000036 +sp\+160 +u +u +
+
+    func idx \[1\]: pc = 0x38, size = 92 bytes
+    STARTPC +CFA +FP +RA +
+    0000000000000038 +sp\+160 +u +u +
+    000000000000003e +sp\+160 +c-72 +c-48 +
+    0000000000000042 +sp\+336 +c-72 +c-48 +
+    0000000000000046 +fp\+336 +c-72 +c-48 +
+    0000000000000092 +sp\+160 +u +u +
+
+    func idx \[2\]: pc = 0x98, size = 52 bytes
+    STARTPC +CFA +FP +RA +
+    0000000000000098 +sp\+160 +u +u +
+    000000000000009e +sp\+160 +c-72 +c-48 +
+    00000000000000a2 +sp\+832 +c-72 +c-48 +
+    00000000000000a6 +fp\+832 +c-72 +c-48 +
+    00000000000000ca +sp\+160 +u +u +
+
+    func idx \[3\]: pc = 0xd0, size = 58 bytes
+    STARTPC +CFA +FP +RA +
+    00000000000000d0 +sp\+160 +u +u +
+    00000000000000d6 +sp\+160 +c-72 +c-48 +
+    00000000000000da +sp\+320 +c-72 +c-48 +
+    00000000000000de +fp\+320 +c-72 +c-48 +
+    0000000000000108 +sp\+160 +u +u +
diff --git a/binutils/testsuite/binutils-all/x86-64/README-sframe-tests b/binutils/testsuite/binutils-all/x86-64/README-sframe-tests
new file mode 100644
index 00000000000..b5b3f0cb7fa
--- /dev/null
+++ b/binutils/testsuite/binutils-all/x86-64/README-sframe-tests
@@ -0,0 +1,96 @@
+The tests in sframe.exp use binary data files:
+  - test-v2-ET_EXEC.sframe.bz2
+  - test-v2-ET_REL.sframe.bz2
+These files are generated using a as/ld supporting SFrame V2 sections (Binutils
+<= 2.45).  The purpose of those tests is to make sure readelf/objdump support
+works for SFrame V2.
+
+The binary files are generated using the following steps.
+
+$ cat sort.s
+	.text
+	.p2align 4
+	.globl	swapit
+	.type	swapit, @function
+swapit:
+	.cfi_startproc
+	movl	(%rsi), %eax
+	.cfi_def_cfa_register 6
+	.cfi_offset 6, 16
+	movl	%eax, (%rdi)
+	.cfi_def_cfa_register 7
+	ret
+	.cfi_endproc
+	.size	swapit, .-swapit
+
+	.p2align 4
+	.globl	fake_sort
+	.type	fake_sort, @function
+fake_sort:
+	.cfi_startproc
+	testl	%esi, %esi
+	jg	.L5
+	ret
+	.p2align 4,,10
+	.p2align 3
+.L5:
+	movslq	%esi, %rsi
+	leaq	-4(%rdi,%rsi,4), %rsi
+	jmp	swapit
+	.cfi_endproc
+	.size	fake_sort, .-fake_sort
+
+	.text
+	.p2align 4
+	.globl	sort_array
+	.type	sort_array, @function
+sort_array:
+	.cfi_startproc
+	subq	$520, %rsp
+	.cfi_def_cfa_offset 528
+	movl	$128, %esi
+	movq	%rsp, %rdi
+	call	fake_sort
+	addq	$520, %rsp
+	.cfi_def_cfa_offset 8
+	ret
+	.cfi_endproc
+	.size	sort_array, .-sort_array
+
+	.section	.rodata.str1.1,"aMS",@progbits,1
+.LC0:
+	.string	"done"
+
+	.section	.text.startup,"ax",@progbits
+	.p2align 4
+	.globl	main
+	.type	main, @function
+main:
+	.cfi_startproc
+	subq	$8, %rsp
+	.cfi_def_cfa_offset 16
+	call	sort_array
+	movl	$.LC0, %edi
+	xorl	%eax, %eax
+	call	printf
+	xorl	%eax, %eax
+	addq	$8, %rsp
+	.cfi_def_cfa_offset 8
+	ret
+	.cfi_endproc
+
+        .globl	_start
+        .type	_start,@function
+_start:
+        call main
+	.size	main, .-main
+
+$ as --gsframe -o sort.o sort.s
+$ ld -lc sort.o -o sort
+
+$ cp sort test-v2-ET_EXEC.sframe
+$ chmod -x test-v2-ET_EXEC.sframe
+$ bzip2 test-v2-ET_EXEC.sframe
+
+$ cp sort.o test-v2-ET_REL.sframe
+$ bzip2 test-v2-ET_REL.sframe
diff --git a/binutils/testsuite/binutils-all/x86-64/sframe.exp b/binutils/testsuite/binutils-all/x86-64/sframe.exp
new file mode 100644
index 00000000000..62642152016
--- /dev/null
+++ b/binutils/testsuite/binutils-all/x86-64/sframe.exp
@@ -0,0 +1,63 @@
+# Expect script for x86-64 object tests for SFrame.
+#   Copyright (C) 2026 Free Software Foundation, Inc.
+#
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 3 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston,
+# MA 02110-1301, USA.
+
+if {![istarget "x86_64-*-linux*"] || [is_remote host]} {
+    return
+}
+
+set tempfile tmpdir/sframe-testbin
+
+set test_list [lsort [glob -nocomplain $srcdir/$subdir/*.sframe.bz2]]
+foreach t $test_list {
+    # We need to strip the ".bz2", but can leave the dirname.
+    set test $subdir/[file tail $t]
+    set testname [file rootname $test]
+    verbose $testname
+
+    # We will check against the expected output in file named ${dumpfile}.dump
+    set dumpfile [file rootname $t]
+
+    if {[catch "system \"bzip2 -dc $t > $tempfile\""] != 0} {
+	untested "bzip2 -dc ($tempfile)"
+	continue
+    }
+
+    # Check readelf output of SFrame V2 sections.
+    set got [remote_exec host "$READELF --sframe $tempfile" "" "/dev/null" "${tempfile}.out"]
+    if { [lindex $got 0] != 0 || ![string match "" [lindex $got 1]] } then {
+	fail "readelf SFrame V2 ($testname)"
+	continue
+    }
+
+    if { [regexp_diff "${tempfile}.out" "${dumpfile}.dump"] } then {
+	fail "readelf SFrame V2 ($testname)"
+    }
+    pass "readelf SFrame V2 ($testname)"
+
+    # Check objdump output of SFrame V2 sections as well.
+    set got [remote_exec host "$OBJDUMP --sframe $tempfile" "" "/dev/null" "${tempfile}.out"]
+    if { [lindex $got 0] != 0 || ![string match "" [lindex $got 1]] } then {
+	fail "objdump SFrame V2 ($testname)"
+	continue
+    }
+
+    if { [regexp_diff "${tempfile}.out" "${dumpfile}.dump"] } then {
+	fail "objdump SFrame V2 ($testname)"
+    }
+    pass "objdump SFrame V2 ($testname)"
+}
diff --git a/binutils/testsuite/binutils-all/x86-64/test-v2-ET_EXEC.sframe.bz2 b/binutils/testsuite/binutils-all/x86-64/test-v2-ET_EXEC.sframe.bz2
new file mode 100644
index 0000000000000000000000000000000000000000..e9686735516b40e59a699583ab37091680a8aa3a
GIT binary patch
literal 1424
zcmV;B1#kL7T4*^jL0KkKSw>ho<^TnB|NsC0|NZ{k|6l+2|KtDf|NZW6O+>&z0Kx18
zKugm6$4$@#p2U%$t6H-`XlP9o(-9|%XfZuQ)CZ}f$^+CiXlNP$G-&jI10zA8$)nOV
zXgxq4pa1~%H1!6iAV3gI3NRvmqf-HsKs3=XfY8EVi~~&>04A7>0(zOIqbHQpMkbmt
z5HvDrp@_+*fXL7q7@7<wMi9shhM5M9G8q8G#4t=I36Z9l0GJ36G%{(Sh{>ja$j}-X
znhYjJ5XcOMnFftA834q@Fia*1k*1gcm<R-k2vZ2vJx|k0JerSFC#iyH0iYUrH5zH^
z3?_p?kj+M(rhqi{02%-Q(;y8zh&Wkw_`2*WPb`Cho5Z!Y1J`K{iL@f_KwgYX(C9==
zi3>>E<+Aqq;V;e5G&NAQ#^Sg-<h#m-l^C{EMOvN~Ew6r4g5iTb9PkPe6LV#5xGs!c
zOuL#hM>vV1s;QWQaT=cLv_31=CIm2d7K)gwFi}UNm#3;2bX5T=h8=qt@6cDr$+Dd$
zizM(kW@Zc*+@lr;Tvqx<6XuXMF#$23ZVhcM)vly^J%7=};pH4!_BRj<aV%|y9IU+t
zb%;pWW>2u%_BVBw012VoTC=bzk=&vV^@C2slH``9N1!z+Lq{ovUP~tTfh$Du;$iOb
zw$7N9^Axm!*@$$}ghiPla9wwp)wFj_D=dg&q@)Kc-QCF~96uTaXRttQ7$FO|V%f1H
z8Lg|uX(}{#EiAU$0ZE8Fel3y&w3q}{2tcgYnKD5Q2?q0<09R6kwrFPoh*M}Lnuf5M
z6_M(UiiJcW+w0t4(!#>FpLDq-V1bd)8OJ<f*{Drfg1a%nb?Is8+oc`q<JhEgx%l$2
zpx-pQET~I4fQ(jTag660&$AxN|GCp5bb8lVFnTael!pUmlRlZiO^C#32{a1k{^ui7
zbEQt}G)X}XwQ1ic8LT~KO`n?s4T!sT;=`1pX$M(}kEgFODljxdywI0~-rfOG!x5gr
zVHWLMn~6veTE4<L1Qz7BBX1i0aswiMGprWG8{tVLBA6$yl8r~4t?5Rn=nNh`A`yUS
zP8WTv%8+E<rP=JPUsmG^)m$2qvvUZW5qW~N!z0olxTc$HJV)WjIBu^eF}LJ}ka(V(
zV%0N4Nr2{8p%oqL9H*t<Pl$EomC5*C2xrlq0;EC|H7MW{A>NY7K><L0jE>W4GAM$g
z21QwfN|5P-IKk!7=Yg8J!KW#$^%O)x997OPBqA}c;qm5A@(s${dm!kI+gR+-(3FGX
z@8L-0^}2@p23AxVAv_-m))9v0<S6jbYalp>ZmTYv3R%}RC6EVRQ)K4dB6@`rXBddG
zGzf@uP!pk2W3mc~lQS&2WtOXCqROA4NA8b3Wmcbqh2KGy;K&!`(8$W_O{PysQ;TBp
zRs*LAi^STRdm<mJu}X(W<yErF@<+>dCXx4fXGpFeB4!<%th--B5!hlGC%QdEbQ~MK
zPq9OXkjnOL=z8i0L8K0TO|elAF)et|z*XA$C#WXL4$6&_8uG>=jQv1#hVHZBP+D5F
zL@Ej`W!??2rCqdxg%!sSL`uPoZBf>;M&pSB)s_WN1Y$^7GbpgzDQ!G*$Sp>7E7q_g
zWiUlf5)m0ZB<*215P~anp5cr`I_}<`M3kZgEJ^88B8Y<2-z7DG!EV*orA|f*3S+D5
za1+af*46j}NMNafV1&&H3rrLDDYJ$IQ7Q-&lPzIj)<}qmhdCJ_P=b(FPPvEUPJ~#G
zn-QO?t5w?^Ivn_~heoS!L4K6K(xoeTx0rwCZjbZjYTv$F8zY6wk_2jhw3gi=k5!BQ
eVefIo+JXqgIT|cnTGgS4{x0N-aG@ZKuyxEEsg#}o

literal 0
HcmV?d00001

diff --git a/binutils/testsuite/binutils-all/x86-64/test-v2-ET_EXEC.sframe.dump b/binutils/testsuite/binutils-all/x86-64/test-v2-ET_EXEC.sframe.dump
new file mode 100644
index 00000000000..b89271ea26f
--- /dev/null
+++ b/binutils/testsuite/binutils-all/x86-64/test-v2-ET_EXEC.sframe.dump
@@ -0,0 +1,45 @@
+#...
+Contents of the SFrame section .sframe:
+  Header :
+
+    Version: SFRAME_VERSION_2
+    Flags: SFRAME_F_FDE_SORTED,
+           SFRAME_F_FDE_FUNC_START_PCREL
+    CFA fixed RA offset: -8
+    Num FDEs: 6
+    Num FREs: 14
+
+  Function Index :
+
+    func idx \[0\]: pc = 0x401000, size = 16 bytes
+    STARTPC +CFA +FP +RA +
+    0000000000401000 +sp\+16 +u +f +
+    0000000000401006 +sp\+24 +u +f +
+
+    func idx \[1\]: pc = 0x401010, size = 16 bytes
+    STARTPC\[m\] +CFA +FP +RA +
+    0000000000000000 +sp\+8 +u +f +
+    000000000000000b +sp\+16 +u +f +
+
+    func idx \[2\]: pc = 0x401020, size = 28 bytes
+    STARTPC +CFA +FP +RA +
+    0000000000401020 +sp\+8 +u +f +
+    0000000000401024 +sp\+16 +u +f +
+    000000000040103b +sp\+8 +u +f +
+
+    func idx \[3\]: pc = 0x401050, size = 5 bytes
+    STARTPC +CFA +FP +RA +
+    0000000000401050 +sp\+8 +u +f +
+    0000000000401052 +fp\+8 +c\+16 +f +
+    0000000000401054 +sp\+8 +c\+16 +f +
+
+    func idx \[4\]: pc = 0x401060, size = 18 bytes
+    STARTPC +CFA +FP +RA +
+    0000000000401060 +sp\+8 +u +f +
+
+    func idx \[5\]: pc = 0x401080, size = 28 bytes
+    STARTPC +CFA +FP +RA +
+    0000000000401080 +sp\+8 +u +f +
+    0000000000401087 +sp\+528 +u +f +
+    000000000040109b +sp\+8 +u +f +
+
diff --git a/binutils/testsuite/binutils-all/x86-64/test-v2-ET_REL.sframe.bz2 b/binutils/testsuite/binutils-all/x86-64/test-v2-ET_REL.sframe.bz2
new file mode 100644
index 0000000000000000000000000000000000000000..48e6036d8964db4e2b45da044a53399d3c78fd28
GIT binary patch
literal 777
zcmV+k1NQtvT4*^jL0KkKS<wi0CIAA_fA9bQ{7(5La7ACmUcmqF-tqn}KtKS2%m4sE
z5X?nHzygTlcB#07L`6N6^+3^+O{i(3O%14MH1z<`G|`{{28MtJf#`!&@=QZSWND~r
zrhpm%0000013&-(05s7NO*W>UrhsSw0000000000GynocArm7&)HKrrKurxXGGQ11
zX&6Qz%}+^y00mz+BZP;kg{;aHB6Qtcj2EWAM@k*3%96(_H)(Wwh50KcTvNRvqmLxM
z>zF)WWaCO)5{|P`!DU-vUZ9d7RS$I2KIrAS6h>t!5<o$`X+djHIS}GjN;z}`)S8Td
zj9fT2@abjVqzs2zvb=;K0Yz8j+%&J20BNORPuZrC6ys@vBqL1B0U@S@8BM9kd*KpE
zTQpQ3SP-8p2P#5au$yBrjCT=)K|#~TAxb&*ma-us4Tzf3MXPNp=CiLLA|aGqlAs@E
zgcY+$0uKf$jT0FLL8OHvM79>~3UfFq^>*U&J=lQ7f;Aw3q-8MDmG!2RWf1Mm3K3=`
zHDZ7htO}!uOH!UJqOzuABZ_4nf{Xx^7kAm35{Ye>7IUODzIeyNB!kJu+li={pwOV(
z5~J6oR4CiOVMJq%npb=&NL+$=fGJFKR59KtA|h!)P?8jqGd}(zQ>RHPzErt!v49p1
z0RMx9I(w9)?4d}A3gMIA=95J(TriARhZaO40xF6yfEu@3yh8OV6kPy%T`;hDe2f8y
z0LH~#f`N_-tZF2(PsJor`8)^>33&j^S*1pJe8~a4NolNZaY;bAqK7<h6B|X=Mkc+1
zm@@Z~9DI7VDhBAaN5%8Yx6gn*%BO(UY*-W_f$dmbk;%!4_tJ!b@r^%8j6Y1~NKgsa
z4zcz}7<B+dM4+&saIr#b+U9{kvP%L8$jN|&_6bW95Yk6oOK~Qu+GuU`r8id2{MQQ-
z8zE~&Qrc24lKI)#1Sn1qH91v&vHxIlgYYhDtFe(GhJQeXRzMj91#<y_e~Y;yoG3_W
HggcV}rLjod

literal 0
HcmV?d00001

diff --git a/binutils/testsuite/binutils-all/x86-64/test-v2-ET_REL.sframe.dump b/binutils/testsuite/binutils-all/x86-64/test-v2-ET_REL.sframe.dump
new file mode 100644
index 00000000000..463f6af203e
--- /dev/null
+++ b/binutils/testsuite/binutils-all/x86-64/test-v2-ET_REL.sframe.dump
@@ -0,0 +1,33 @@
+#...
+Contents of the SFrame section .sframe:
+  Header :
+
+    Version: SFRAME_VERSION_2
+    Flags: SFRAME_F_FDE_FUNC_START_PCREL
+    CFA fixed RA offset: -8
+    Num FDEs: 4
+    Num FREs: 10
+
+  Function Index :
+
+    func idx \[0\]: pc = 0x0, size = 5 bytes
+    STARTPC +CFA +FP +RA +
+    0000000000000000 +sp\+8 +u +f +
+    0000000000000002 +fp\+8 +c\+16 +f +
+    0000000000000004 +sp\+8 +c\+16 +f +
+
+    func idx \[1\]: pc = 0x10, size = 18 bytes
+    STARTPC +CFA +FP +RA +
+    0000000000000010 +sp\+8 +u +f +
+
+    func idx \[2\]: pc = 0x30, size = 28 bytes
+    STARTPC +CFA +FP +RA +
+    0000000000000030 +sp\+8 +u +f +
+    0000000000000037 +sp\+528 +u +f +
+    000000000000004b +sp\+8 +u +f +
+
+    func idx \[3\]: pc = 0x0, size = 28 bytes
+    STARTPC +CFA +FP +RA +
+    0000000000000000 +sp\+8 +u +f +
+    0000000000000004 +sp\+16 +u +f +
+    000000000000001b +sp\+8 +u +f +
-- 
2.52.0

